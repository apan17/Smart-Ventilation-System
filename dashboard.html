<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Live Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f9; }
        
        /* Header Style */
        .header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        /* Cards Layout */
        .cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card h3 { margin: 0; color: #666; font-size: 0.9rem; }
        .card p { font-size: 2rem; margin: 10px 0; font-weight: bold; }
        
        /* Status Colors */
        .status-safe { color: green; }
        .status-danger { color: red; }
        
        /* Charts Layout */
        .charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .chart-box { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        @media (max-width: 768px) {
            .cards, .charts-container { grid-template-columns: 1fr; }
        }

        #logout { background: #ff4d4d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="header">
        <h2>Smart Ventilation Dashboard</h2>
        <button id="logout" onclick="logout()">Logout</button>
    </div>

    <div class="cards">
        <div class="card">
            <h3>Temperature</h3>
            <p id="temp">-- °C</p>
        </div>
        <div class="card">
            <h3>Gas Level</h3>
            <p id="gas">-- m³</p> 
        </div>
        <div class="card">
            <h3>System Status</h3>
            <p id="status">--</p>
        </div>
    </div>

    <div class="charts-container">
        <div class="chart-box">
            <canvas id="tempChart"></canvas>
        </div>
        <div class="chart-box">
            <canvas id="gasChart"></canvas>
        </div>
    </div>

    <script>
        // ================= CONFIGURATION =================
        const SUPABASE_URL = "https://ukzntvjbkkjcawdzstcw.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVrem50dmpia2tqY2F3ZHpzdGN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2NzU0OTMsImV4cCI6MjA4NDI1MTQ5M30.MOCt8SliawQ-Krw71JQ8kqguMKDu1bO2XqXN4oqio0c";
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Security Check
        if (localStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = 'index.html';
        }

        function logout() {
            localStorage.removeItem('isLoggedIn');
            window.location.href = 'index.html';
        }

        // ================= SETUP CHARTS =================
        
        // 1. Temperature Chart
        const ctx1 = document.getElementById('tempChart').getContext('2d');
        const tempChart = new Chart(ctx1, {
            type: 'line',
            data: { 
                labels: [], 
                datasets: [{ 
                    label: 'Temperature (°C)', 
                    data: [], 
                    borderColor: 'blue', 
                    backgroundColor: 'rgba(0, 0, 255, 0.1)',
                    fill: true,
                    tension: 0.4 
                }] 
            }
        });

        // 2. Gas Chart (Updated Unit to m³)
        const ctx2 = document.getElementById('gasChart').getContext('2d');
        const gasChart = new Chart(ctx2, {
            type: 'line',
            data: { 
                labels: [], 
                datasets: [{ 
                    label: 'Gas Level (m³)',  // <--- Label Changed
                    data: [], 
                    borderColor: 'red', 
                    backgroundColor: 'rgba(255, 0, 0, 0.1)',
                    fill: true,
                    tension: 0.4 
                }] 
            }
        });

        // ================= LOAD HISTORY (NEW FEATURE) =================
        async function loadHistory() {
            // Get last 20 readings
            const { data, error } = await supabaseClient
                .from('readings')
                .select('*')
                .order('id', { ascending: false })
                .limit(20);

            if (data) {
                // Data comes in reverse (newest first), we need to flip it for the chart
                const history = data.reverse(); 

                history.forEach(reading => {
                    const time = new Date(reading.created_at).toLocaleTimeString();
                    addData(tempChart, time, reading.temperature);
                    addData(gasChart, time, reading.smoke_level);
                });
            }
        }

        // ================= LIVE UPDATES =================
        async function fetchData() {
            const { data, error } = await supabaseClient
                .from('readings')
                .select('*')
                .order('id', { ascending: false })
                .limit(1);

            if (data && data.length > 0) {
                const reading = data[0];
                
                document.getElementById('temp').innerText = reading.temperature + " °C";
                document.getElementById('gas').innerText = reading.smoke_level + " m³"; // Unit Changed
                
                const statusEl = document.getElementById('status');
                statusEl.innerText = reading.status;
                statusEl.className = reading.status === 'DANGER' ? 'status-danger' : 'status-safe';

                const time = new Date(reading.created_at).toLocaleTimeString();

                // Only add if it's a new timestamp
                if (tempChart.data.labels[tempChart.data.labels.length - 1] !== time) {
                    addData(tempChart, time, reading.temperature);
                    addData(gasChart, time, reading.smoke_level);
                }
            }
        }

        // Helper: Add data to chart and keep max 20 points
        function addData(chart, label, data) {
            chart.data.labels.push(label);
            chart.data.datasets.forEach((dataset) => {
                dataset.data.push(data);
            });

            if (chart.data.labels.length > 20) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            chart.update();
        }

        // Start Up
        loadHistory(); // 1. Load old data immediately
        setInterval(fetchData, 2000); // 2. Then check for new data every 2s
    </script>
</body>
</html>
